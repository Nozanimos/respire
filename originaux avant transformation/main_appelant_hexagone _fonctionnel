// main.c - VERSION COMPATIBLE
#include <stdio.h>
#include <stdlib.h>
#include <SDL2/SDL.h>
#include "geometry.h"
#include "hexagone_list.h"
#include "renderer.h"
#include "config.h"
// #include "settings_panel.h"

int main(void) {
    AppState app = {0};
    HexagoneList* hex_list = NULL;
    AppConfig config;
    SDL_Event event;
    int done = 1;

    // Charger la configuration
    load_config(&config);

    const int FRAME_DELAY = 1000 / TARGET_FPS;
    Uint32 frame_start;
    int frame_time;
    int frame_count = 0;
    Uint32 last_fps_time = SDL_GetTicks();

    printf("Démarrage de l'application...\n");

    // === INITIALISATION ===
    if (!initialize_app(&app, "Respiration guidée", "../img/nenuphar.jpg")) {
        fprintf(stderr, "Échec initialisation - arrêt\n");
        return EXIT_FAILURE;
    }

    // === CRÉATION DES HEXAGONES ===
    hex_list = create_all_hexagones(app.screen_width/2, app.screen_height/2,
                                    (app.screen_width < app.screen_height) ?
                                    (app.screen_width/2)*3/4 : (app.screen_height/2)*3/4);

    // === PRÉ-CALCULS ===
    precompute_all_cycles(hex_list, TARGET_FPS, BREATH_DURATION);
    print_rotation_frame_requirements(hex_list, TARGET_FPS, BREATH_DURATION);

    // === BOUCLE PRINCIPALE ===
    printf("Boucle principale - ESC pour quitter\n");

    while (done) {
        frame_start = SDL_GetTicks();

        // Gestion événements
        while (SDL_PollEvent(&event)) {
            if (event.type == SDL_QUIT ||
                (event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_ESCAPE)) {
                done = 0;
                }
        }

        // Mise à jour animations
        HexagoneNode* node = hex_list->first;
        while (node) {
            apply_precomputed_frame(node);
            node = node->next;
        }

        // Rendu (fonction originale)
        render_hexagones(&app, hex_list);

        // Régulation FPS
        frame_time = SDL_GetTicks() - frame_start;
        if (frame_time < FRAME_DELAY) {
            SDL_Delay(FRAME_DELAY - frame_time);
        }

        // Affichage FPS
        frame_count++;
        if (SDL_GetTicks() - last_fps_time >= 1000) {
            printf("FPS réel: %d\n", frame_count);
            frame_count = 0;
            last_fps_time = SDL_GetTicks();
        }
    }

    // === NETTOYAGE ===
    printf("Nettoyage...\n");
    free_hexagone_list(hex_list);
    cleanup_app(&app);

    printf("Application terminée\n");
    return EXIT_SUCCESS;
}
